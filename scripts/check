#!/bin/bash
# vim: set ft=sh

set -e

exec 3>&1 # make stdout available as fd 3 for the result
exec 1>&2 # redirect all output to stderr for logging

payload=$(mktemp "${TMPDIR}/gitlab-merge-request-resource.XXXXXX")

cat > "${payload}" <&0

gitlab_host=$(jq -r '.source.gitlab_host // ""' < "${payload}")
private_token=$(jq -r '.source.private_token // ""' < "${payload}")
project_id=$(jq -r '.source.project_id // ""' < "${payload}")
version=$(jq -r '.version // ""' < "${payload}")
version_updated_at=$(jq -r '.version.updated_at // ""' < "${payload}")

if [ -z "${version}" ]; then
  version='{"updated_at":"1800-01-01T00:00:00.000Z"}'
fi

open_mrs=$(curl \
--header "PRIVATE-TOKEN: ${private_token}" \
"https://${gitlab_host}/api/v3/projects/${project_id}/merge_requests?state=opened")

num_mrs="$(echo "${open_mrs}" | jq 'length')"

function to_seconds {
  date -d "$(echo "$1" | sed 's/.\{5\}$//' | tr T ' ')" +%s
}

new_versions=''

for i in $(seq 0 $((num_mrs - 1))); do
  mr="$(echo "${open_mrs}" | jq -r '.['"$i"']')"
  mr_updated_at="$(echo "${mr}" | jq -r '.updated_at')"

  if [ "$(to_seconds "${mr_updated_at}")" -gt "$(to_seconds "${version_updated_at}")" ]; then
      mr_id="$(echo "${mr}" | jq -r '.id')"

      new_versions="${new_versions},{\"updated_at\":\"${mr_updated_at}\",\"mr_id\":\"${mr_id}\"}"
  fi
done

new_versions=${new_versions#','}
new_versions="[${new_versions}]"

if [ "${new_versions}" == '[]' ]; then
  new_versions="[${version}]"
fi

jq -n "${new_versions}" >&3
