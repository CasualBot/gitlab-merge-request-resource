#!/bin/bash

set -e

exec 3>&1 # make stdout available as fd 3 for the result
exec 1>&2 # redirect all output to stderr for logging

payload="${TMPDIR}/gitlab-resource"

cat > "${payload}" <&0

gitlab_host=$(jq -r '.source.gitlab_host // ""' < ${payload})
private_token=$(jq -r '.source.private_token // ""' < ${payload})
project_id=$(jq -r '.source.private_token // ""' < ${payload})
old_state?$(jq -r '.version // ""' < ${payload})

curl \
--header "PRIVATE-TOKEN: ${private_token}" \
"https://${gitlab_host}/api/v3/projects/${project_id}/merge_requests?state=opened&order_by=updated_at"

# example: TMPDIR="/tmp" /opt/resource/check '{ "source": { "gitlab_host": "gitlab.swisscloud.io", "private_token": "xxx", "project_id": "737" } }'
